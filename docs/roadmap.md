# mori 開発ロードマップ (MVP)

## MVPのゴール
- [ ] Linux: cgroup + eBPF による FQDN ベースのネットワーク制御と Landlock によるファイルIO制御を CLI / 設定ファイルから提供する
- [ ] macOS: sandbox-exec をラップし、mori の allow 系フラグと設定ファイルでネットワーク／ファイルIOを制御できるようにする
- [ ] 共通 CLI: mori 仕様の allow 系フラグと設定フォーマットを通じて、単一プロファイルで両OSに同等の制約を適用できるようにする

## フェーズ0: 基盤準備と既存資産の取り込み
### TODO
- [x] `sbx` README のフラグ仕様を参考資料として整理する
- [x] cage と rust-landlock の API / 実装パターンを調査し再利用方針を決める
- [ ] クロスプラットフォーム共通 CLI エントリポイントと設定ロード処理の骨格を設計する
- [ ] テスト環境（macOS / Linux）の実行確認と自動化手段の下調べを行う
### このフェーズで決めること
- [ ] mori 独自 CLI フラグの正式仕様と優先度（allow 系のみ、FQDN / CIDR 対応）
- [ ] 内部モジュール構成（OS ごとの実装切り替え、共通のポリシー中間表現）
- [ ] 設定ファイルフォーマット（YAML/TOML 等）と検索優先順位、バリデーション方針
- [ ] 既存ライブラリのバージョン固定と更新ポリシー

## フェーズ1: Linux 向けネットワーク制御
### TODO
- [ ] connect4 / connect6 にフックする eBPF プログラムを作成し cgroup にアタッチする
- [ ] Hickory DNS による FQDN→IP 解決と eBPF マップ更新ループ（TTL 尊重）を実装する
- [ ] mori CLI / 設定ポリシーから Linux ネットワーク許可ルール（FQDN / IP / CIDR）への変換レイヤーを実装する
- [ ] 拒否イベントのログ出力と最低限の観測手段（構造化ログ等）を整備する
### このフェーズで決めること
- [ ] 許可ルールの内部表現（ポート省略時の扱い、任意ポート表現）
- [ ] DNS 再解決ポリシー（TTL 尊重、有効期限切れ時の挙動、リトライ戦略）
- [ ] 拒否 / エラー時のユーザー通知手段（stderr、ログフォーマット）

## フェーズ2: macOS 向けネットワーク制御
### TODO
- [ ] mori のポリシー表現から sandbox-exec S式を生成するテンプレート・変換ロジックを実装する
- [ ] Linux と同じ allow 系フラグ / 設定で macOS のネットワーク制限を適用できるラッパーを整備する
- [ ] macOS 固有制約（DNS 解決、コード署名、暗黙許可対象等）を洗い出し対策をまとめる
### このフェーズで決めること
- [ ] sandbox-exec プロファイルにおける FQDN / CIDR 指定方法と制約
- [ ] システムライブラリの暗黙許可セットと管理方法
- [ ] sandbox-exec 実行まわりの UX（エラーメッセージ、デバッグログ）

## フェーズ3: 共通 CLI / 設定と UX 統合
### TODO
- [ ] OS 自動判定と単一 CLI から Linux / macOS 実装を切り替える仕組みを整える
- [ ] CLI フラグ・設定ファイル→中間表現→OS 別実装への変換モジュールを共通化する
- [ ] プロファイル読込・バリデーション・エラーハンドリングを統一し、ログフォーマットを揃える
- [ ] 設定ファイルの検索経路（`--config` 明示、既定ディレクトリ探索）を実装する
### このフェーズで決めること
- [ ] プロファイル配布形式（内蔵テンプレート、外部ファイル、バンドル方法）
- [ ] ユーザー向けメッセージ仕様（成功 / 失敗 / 警告）
- [ ] CLI フラグと設定ファイルの優先順位、重複指定時の扱い
- [ ] 最低限のドキュメント構成（README、クイックスタート、FAQ）

## フェーズ4: MVP 検証とドキュメント整備
### TODO
- [ ] 代表的ユースケースに対する E2E テストと CI 自動検証を作成する
- [ ] CLI 使用例・設定ファイル例・制限事項を整理しドキュメント化する
- [ ] MVP 完了条件レビューと残課題の洗い出しを行う
### このフェーズで決めること
- [ ] テストカバレッジの最小ライン（OS / 操作ケースごと）
- [ ] 公開時に明記する既知の制限と今後の拡張候補
- [ ] MVP 完了の正式判断プロセス
